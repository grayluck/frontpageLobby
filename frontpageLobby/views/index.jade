extends layout

block content
    h1= title
    p Welcome to #{title}
    #content Message should come out here

    button(id='testButton') test

    +alert('alert', 'Please log in first.')

    script(src='/socket.io/socket.io.js')
    script.
        var messages = [];
        function newMessage(msg) {
            messages.push(msg);
            var html = '';
            for(var i=0; i<messages.length; i++) {
                html += messages[i] + '<br />';
            }
            content.innerHTML = html;
        }

    script.
        // Dealing with realtime connection
        var content = document.getElementById("content");
        var socket = io.connect('http://localhost:3000');
        socket.on('message', function (data) {
            newMessage(data.content);
        });

    script.

        $('#alert').on('hidden.bs.modal', function () {
            window.location.href = '/login';
        });

        // Page logic control
        function logout() {
            utils.setCookie('token', '', 100);
            window.location.href = '/login';
        }

        function postMessage() {
            var token = utils.getCookie('token');
            var content = 'asdfaaa';
            $.ajax({
                url: '/api/postMsg',
                method: 'POST',
                data: {
                    token: token,
                    content: content
                },
                success: function(data) {
                    if(data.error) {
                        // the user is not logged in
                        $('#alert').modal({
                            backdrop: true
                        });
                    } else {
                        // new message should from the server dynamically
                        // newMessage(content);
                    }
                }
            })
        }

        function getMessage() {
            $.ajax({
                url: '/api/getMsg',
                method: 'GET',
                success: function(data) {
                    for(var i = 0; i < data.length; ++i) {
                        console.log(data[i]);
                        newMessage(data[i].content);
                    }
                }
            });
        }

        getMessage();

        $('#testButton').click(function(){
            postMessage();
        });
